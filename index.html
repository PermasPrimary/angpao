import React, { useState, useEffect } from 'react';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { AlertDialog, AlertDialogContent, AlertDialogHeader, AlertDialogTitle, AlertDialogDescription, AlertDialogAction } from '@/components/ui/alert-dialog';

const LuckyPacketGame = () => {
  const [packets, setPackets] = useState([]);
  const [openPacket, setOpenPacket] = useState(null);
  const [remainingPackets, setRemainingPackets] = useState(50);
  const [showAlert, setShowAlert] = useState(false);

  const rewards = [
    { type: '好学币', amount: 5, probability: 0.3 },
    { type: '好学币', amount: 10, probability: 0.3 },
    { type: '好学币', amount: 20, probability: 0.1 },
    { type: '零食小礼包', amount: null, probability: 0.1 },
    { type: '精美文具', amount: null, probability: 0.1 },
    { type: '神秘礼物', amount: null, probability: 0.1 },
  ];

  useEffect(() => {
    initializePackets();
  }, []);

  const initializePackets = () => {
    const newPackets = [];
    for (let i = 0; i < 50; i++) {
      const randomValue = Math.random();
      let cumulativeProbability = 0;
      let selectedReward;
      
      for (const reward of rewards) {
        cumulativeProbability += reward.probability;
        if (randomValue <= cumulativeProbability) {
          selectedReward = reward;
          break;
        }
      }
      
      newPackets.push({
        id: i,
        opened: false,
        reward: selectedReward
      });
    }
    setPackets(newPackets);
  };

  const handlePacketClick = (packet) => {
    if (packet.opened) return;
    
    const updatedPackets = packets.map(p => 
      p.id === packet.id ? { ...p, opened: true } : p
    );
    
    setPackets(updatedPackets);
    setOpenPacket(packet);
    setShowAlert(true);
    setRemainingPackets(prev => prev - 1);
  };

  const handleCloseAlert = () => {
    setShowAlert(false);
    setOpenPacket(null);
  };

  const renderReward = (reward) => {
    if (reward.type === '好学币') {
      return `获得${reward.amount}个好学币！`;
    }
    return `恭喜获得${reward.type}！`;
  };

  return (
    <div className="w-full max-w-6xl mx-auto p-4">
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold text-red-600 mb-4">新年抽红包</h1>
        <p className="text-lg text-gray-600">还剩 {remainingPackets} 个红包未开启</p>
      </div>

      <div className="grid grid-cols-5 gap-6 p-4">
        {packets.map((packet) => (
          <Button
            key={packet.id}
            onClick={() => handlePacketClick(packet)}
            className={`h-20 flex items-center justify-center text-xl relative ${
              packet.opened 
                ? 'bg-gray-200 cursor-not-allowed' 
                : 'bg-red-600 hover:bg-red-700'
            }`}
            disabled={packet.opened}
          >
            <div className="text-base">{packet.opened ? '开' : '学品'}</div>
          </Button>
        ))}
      </div>

      <AlertDialog open={showAlert} onOpenChange={handleCloseAlert}>
        <AlertDialogContent className="bg-red-50">
          <AlertDialogHeader>
            <AlertDialogTitle className="text-2xl text-red-600">恭喜发财!</AlertDialogTitle>
            <AlertDialogDescription className="text-lg">
              {openPacket && renderReward(openPacket.reward)}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <div className="flex justify-center mt-4">
            <AlertDialogAction onClick={handleCloseAlert} className="bg-red-600 text-white hover:bg-red-700">
              继续抽红包
            </AlertDialogAction>
          </div>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
};

export default LuckyPacketGame;
